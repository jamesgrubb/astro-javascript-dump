---
import BaseLayout from "../layout/BaseLayout.astro";
---

<BaseLayout title="import">
  <!-- <h1>{data.greeting}</h1> -->
  <form id="form">
    <input type="file" name="upload" id="fileInput" accept="image/*" />
  </form>
</BaseLayout>

<script>
  const input = document.getElementById("fileInput") as HTMLInputElement;
  input.addEventListener("change", handleFileInput, false);

  function handleFileInput() {
    if (!input?.files || !input?.files[0]) return;
    fileUpload(input.files[0]);
  }

  async function fileUpload(file: File) {
    const reader = new FileReader();
    const fd = new FormData();
    if (!file) return;

    try {
      reader.addEventListener("loadend", async function () {
        fd.append("dataUrl", reader.result);
        fd.append("file", file);

        const res = await fetch("/eval", {
          method: "POST",
          // Use "cors" mode or omit the "mode" option for same-origin requests
          // mode: "cors",
          body: fd,
        });
        for (var pair of fd.entries()) {
          console.log(pair[0] + ", " + pair[1]);
        }

        const result = await res.json(); // Assuming the response is JSON
        console.log("Server response:", JSON.stringify(result));
      });
      if (file) {
        reader.readAsDataURL(file);
      }
    } catch (error) {
      console.error("File upload failed", error);
    }
  }
</script>
